<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>solux project saessak_plants2</title>
    <link rel="stylesheet" href="../css/solux_project_base.css">
    <link rel="stylesheet" href="../css/solux_project_detail.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<!--ìƒì„¸ ì •ë³´ html-->
<body>
  <div class="container">
    <nav class="sidebar">
      <div class="sidebar-logo">
        <img src="../image/sidebar.png" alt="ì‚¬ì´ë“œë°”" />
      </div>
      <ul>
        <li>
          <a href="solux_project_home.html"><img src="../image/Home.png" alt="í™ˆ" class="menu-icon" /> Home</a>
        </li>
        <li>
          <a href="solux_project_plants.html"><img src="../image/Plants.png" alt="ì‹ë¬¼" class="menu-icon" /> Plants</a>
        </li>
        <li>
          <a href="solux_project_calendar.html"><img src="../image/Calendar.png" alt="ë‹¬ë ¥" class="menu-icon" /> Calendar</a>
        </li>
        <li>
          <a href="solux_project_bugspot.html"><img src="../image/BugSpot.png" alt="ë³‘ì¶©í•´" class="menu-icon" /> Bug Spot</a>
        </li>
        <li>
          <a href="solux_project_settings.html"><img src="../image/Settings.png" alt="ì„¤ì •" class="menu-icon" /> Settings</a>
        </li>
      </ul>
    </nav>
    <!-- ë©”ì¸ -->
     <div class="main-wrapper">
        <div class="logo-area">
          <img src="../image/Logo_full.png" alt="ë¡œê³ " class="saessak-img">
        </div>
     </div>
     
    <main class="content">

      <div class="plant-detail-container" id="plant-detail">
        <div class="plant-image-section">
          <img id="plantImage" src="" alt="ì‹ë¬¼ ì‚¬ì§„" class="plant-photo" />
          <h2 id="plantNickname" class="plant-name"></h2>
          <p id="plantSpecies" class="plant-species"></p>
          <p id="plantCreatedAt" class="plant-date"></p>
        </div>

        <div class="plant-info-section">
          <div class="watering-tracker">
            <h3>Watering Tracker</h3>
            <p><span class="drop-icon">ğŸ’§</span> ë¬¼ì„ ì¤€ ì§€ <span id="wateringDays" class="days">-</span>ì¼ì´ ì§€ë‚¬ì–´ìš”!</p>
            <div class="progress-bar">
              <div id="wateringBar" class="progress-fill" style="width:0%;"></div>
            </div>
            <p class="dates">ì´ì „ ë¬¼ì£¼ê¸° <span id="wateringDate1">-</span></p>
            <p class="dates">ë‹¤ìŒ ë¬¼ì£¼ê¸° <span id="wateringDate2" class="next">-</span></p>
            <button class="water-button" id="wateredBtn">ë¬¼ì£¼ê¸° ì™„ë£Œ!</button>
          </div>

          <div class="repotting-tracker" id="repottingInfo"></div>

          <div class="plant-memo" id="plantMemo">ë©”ëª¨</div>

          <div class="plant-location" id="plantLocation">ì¥ì†Œ</div>
          <button id="deletePlantBtn">ì‚­ì œ</button>
          <!--
          <div class="bug-info" id="pestInfo">ë³‘ì¶©í•´ ì •ë³´</div>
          -->
        </div>
      </div>

    <script>
    const supabaseUrl = 'https://iiskzhqeshvyjkyvsvhz.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlpc2t6aHFlc2h2eWpreXZzdmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NDU0MDQsImV4cCI6MjA2OTUyMTQwNH0.IuPIflTHUWDkR7bSwqP_A5WrUhuasXqbCdlyTzJtcL4'
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey)

    const params = new URLSearchParams(window.location.search);
    const plantId = params.get('id');

    const plantDetailContainer = document.getElementById('plant-detail');

    if (!plantId) {
      plantDetailContainer.innerHTML = "<p>ì‹ë¬¼ IDê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
    } else {
      async function fetchPlant() {
        const { data, error } = await supabaseClient
          .from('table_addplants')
          .select('id, created_at, nickname, species, date1, date2, date3, memo, image_url, location')
          .eq('id', plantId)
          .single();

        if (error) {
          alert(`ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${error.message}`);
          return;
        }

        if (!data) {
          alert("ì‹ë¬¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
          }

        // ì´ë¯¸ì§€ URLì´ ìˆë‹¤ë©´ í•´ë‹¹ ì´ë¯¸ì§€ í‘œì‹œ, ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€ ì²˜ë¦¬
        const plantImage = document.getElementById('plantImage');
        if (data.image_url) {
            plantImage.src = data.image_url;
            plantImage.alt = data.nickname || 'ì‹ë¬¼ ì´ë¯¸ì§€';
          } else {
            plantImage.src = '../image/default-plant.png'; // ê¸°ë³¸ ì´ë¯¸ì§€
          plantImage.alt = 'ê¸°ë³¸ ì‹ë¬¼ ì´ë¯¸ì§€';
        }

        // data: DBì—ì„œ ë°›ì•„ì˜¨ ì‹ë¬¼ ë°ì´í„°
      document.getElementById('plantNickname').textContent = data.nickname || '-';
      document.getElementById('plantSpecies').textContent = data.species || '-';

      // date1: ë§Œë‚œ ë‚ ì§œ (ì‹ë¬¼ ì´ë¦„ ë°‘)
      document.getElementById('plantCreatedAt').textContent = data.date1
        ? new Date(data.date1).toLocaleDateString()
        : '-';

      // date2: ë¬¼ê°ˆì´ ë‚ ì§œ
      const wateringIntervals = {
          ìŒì§€: 60,       // ìŒì§€ - 2ë‹¬ë§ˆë‹¤ ë¬¼ì£¼ê¸°
          ë°˜ìŒì§€: 30,  // ë°˜ìŒì§€ - 1ë‹¬ë§ˆë‹¤ ë¬¼ì£¼ê¸°
          ë°˜ì–‘ì§€: 14,  // ë°˜ì–‘ì§€ - 2ì£¼ë§ˆë‹¤ ë¬¼ì£¼ê¸°
          ì–‘ì§€: 7        // ì–‘ì§€ - 1ì£¼ë§ˆë‹¤ ë¬¼ì£¼ê¸°
        };
      const prevWaterDateEl = document.getElementById('wateringDate1');
      const nextWaterDateEl = document.getElementById('wateringDate2');

      const location = data.location || 'shade';  // ê¸°ë³¸ê°’ ì§€ì •
      const wateringInterval = wateringIntervals[location] || 30;  // ì—†ë‹¤ë©´ ê¸°ë³¸ 30ì¼ ì£¼ê¸° (ì•ˆì „ì¥ì¹˜)

      if (data.date2) {
        const prevWaterDate = new Date(data.date2);
  
        // í•œêµ­ì‹œê°„ ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ (ë…„,ì›”,ì¼ë§Œ ë¹„êµ)
        const now = new Date();
        const todayKST = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  
        // ë¬¼ ì¤€ ë‚ ë„ ë…„,ì›”,ì¼ë§Œ (ë¡œì»¬/í•œêµ­ ì‹œê°„ ê¸°ì¤€)
        const prevWaterDateKST = new Date(prevWaterDate.getFullYear(), prevWaterDate.getMonth(), prevWaterDate.getDate());

        // ë‚ ì§œì°¨ì´ ê³„ì‚°
        const diffTime = todayKST - prevWaterDateKST; // ë°€ë¦¬ì´ˆ ë‹¨ìœ„
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        document.getElementById('wateringDays').textContent = diffDays;
  
        prevWaterDateEl.textContent = prevWaterDate.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul' });

        // ë‹¤ìŒ ë¬¼ì£¼ëŠ” ë‚ ì§œ
        const nextWaterDate = new Date(prevWaterDateKST); // ê°™ì€ ê¸°ì¤€ìœ¼ë¡œ
        nextWaterDate.setDate(nextWaterDate.getDate() + wateringInterval);
        nextWaterDateEl.textContent = nextWaterDate.toLocaleDateString('ko-KR', { timeZone: 'Asia/Seoul' });

        // ì›Œí„°ë§ ë°” ë„ˆë¹„
        const widthPercent = Math.min((diffDays / wateringInterval) * 100, 100);
        document.getElementById('wateringBar').style.width = widthPercent + '%';

      } else {
        prevWaterDateEl.textContent = '-';
        nextWaterDateEl.textContent = '-';
        document.getElementById('wateringDays').textContent = '-';
        document.getElementById('wateringBar').style.width = '0%';
      }

      // date3: ì´ì „ ë¶„ê°ˆì´ ë‚ ì§œ - ë¶„ê°ˆì´ íŠ¸ë˜ì»¤ ì˜ì—­ì— í‘œì‹œ
      const repottingInfoEl = document.getElementById('repottingInfo');

      if (data.date3) {
        const repotDate = new Date(data.date3);
        const repotDays = Math.floor((new Date() - repotDate) / (1000 * 60 * 60 * 24));
        repottingInfoEl.innerHTML = `
          <strong>ë¶„ê°ˆì´ íŠ¸ë˜ì»¤</strong><br />
          ${repotDays}ì¼ ì „ (${repotDate.toLocaleDateString()})
        `;
      } else {
        repottingInfoEl.innerHTML = `
          ë¶„ê°ˆì´ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.<br />
        `;
      }

      //ë©”ëª¨
     const memoEl = document.getElementById('plantMemo');
        if (data.memo && data.memo.trim() !== "") {
          memoEl.innerHTML = `<strong>ë©”ëª¨</strong><br>${data.memo}`;
        } else {
          memoEl.innerHTML = `<strong>ë©”ëª¨</strong><br>ê¸°ë¡ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.`;
        }
      
      //ì¥ì†Œ
      const locationEl = document.getElementById('plantLocation');
      if (data.location && data.location.trim() !== "") {
        locationEl.innerHTML = `<strong>ì¥ì†Œ</strong><br>${data.location} - ${wateringIntervals[data.location] || 'ì£¼ê¸° ë¯¸ì •'}ì¼ ì£¼ê¸°ë¡œ ë¬¼ì„ ì£¼ë©´ ì¢‹ìŠµë‹ˆë‹¤`;
      } else {
        locationEl.innerHTML = `<strong>ì¥ì†Œ</strong><br>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`;
      }
    }
      fetchPlant();

      //ë¬¼ì£¼ê¸° ì™„ë£Œ
      function getKSTISOString() {
        const now = new Date();
        const kstTime = new Date(now.getTime() + 9 * 60 * 60 * 1000); // UTC +9ì‹œê°„
        return kstTime.toISOString().replace('Z', '');
      }

      document.getElementById('wateredBtn').addEventListener('click', async () => {
        const newDate = getKSTISOString();  // newDate ë³€ìˆ˜ëª… ìœ ì§€, í•œêµ­ ì‹œê°„ ISO ë¬¸ìì—´ ìƒì„±
        
        const { data, error } = await supabaseClient
          .from('table_addplants')
          .update({ date2: newDate })
          .eq('id', plantId);

        if (error) {
          alert('ë¬¼ ì¤€ ë‚ ì§œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message);
          return;
        } 
        // ì—…ë°ì´íŠ¸ í›„ ë³€ê²½ëœ ë°ì´í„° ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
      const { data: updatedData, error: selectError } = await supabaseClient
        .from('table_addplants')
        .select('*')
      .eq('id', plantId)
      .single();  

      if (selectError) {
        alert('ì—…ë°ì´íŠ¸ í›„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ' + selectError.message);
        return;
      }
      await fetchPlant(); // ìµœì‹  ë°ì´í„°ë¡œ í™”ë©´ ê°±ì‹ 
    });
    }

    // ì‚¬ì´ë“œë°” í´ë¦­ ì‹œ active í† ê¸€ ë° ì´ë¯¸ì§€ êµì²´
    function handleSidebarClick(clickedAnchor, section, newImageSrc) {
      document.querySelectorAll('.sidebar a').forEach(a => {
        if (a.dataset.originalInner) {
          a.innerHTML = a.dataset.originalInner;
        }
        a.classList.remove('active');
      });

      clickedAnchor.innerHTML = `<img src="${newImageSrc}" alt="${section}" class="menu-icon-selected" /> ${section.charAt(0).toUpperCase() + section.slice(1)}`;
      clickedAnchor.classList.add('active');
    }

document.getElementById('deletePlantBtn').addEventListener('click', async () => {
  const confirmDelete = confirm('ì •ë§ ì´ ì‹ë¬¼ì„ ì‚­ì œí• ê¹Œìš”?');
  if (!confirmDelete) return;

  console.log("ì‚­ì œ ì‹œë„í•  plantId:", plantId);  // ì‚­ì œ ì „ id í™•ì¸

  const { data, error } = await supabaseClient
    .from('table_addplants')
    .delete()
    .eq('id', plantId);  

  
  console.log("ì‚­ì œ ê²°ê³¼:", data);

  if (error) {
    alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
    console.error(error);
  } else {
    alert('ì‚­ì œ ì™„ë£Œ!');
    console.log("ì‚­ì œ ê²°ê³¼:", data);
    window.location.href = 'solux_project_plants.html';
  }

});


  </script>
</body>
</html>